<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngọc Anh Hotel Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .room-card { transition: all 0.2s ease-in-out; }
        .room-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .room-card:active { transform: scale(0.98); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* Toast Notification */
        .toast {
            visibility: hidden; min-width: 300px; background-color: #1e293b; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px;
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 80px; }
        
        /* Images & Auth */
        .bg-hotel { background-image: url('https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80'); background-size: cover; background-position: center; }
        .login-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .auth-switch { cursor: pointer; color: #3b82f6; font-weight: 600; }
        .auth-switch:hover { text-decoration: underline; }
        .img-cover { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="w-full max-w-4xl flex flex-col md:flex-row bg-white rounded-2xl shadow-2xl overflow-hidden h-auto md:h-[600px] fade-in">
            <div class="hidden md:flex w-1/2 bg-hotel p-12 flex-col justify-between text-white relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-900/60 backdrop-blur-[2px]"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-6"><i data-lucide="building-2" class="w-10 h-10 text-white"></i><span class="font-bold text-3xl tracking-wider">NGỌC ANH</span></div>
                    <h1 class="text-4xl font-bold mb-4">Hệ thống Quản lý Khách sạn</h1>
                    <p class="text-blue-100 opacity-90 text-lg">Đồng bộ dữ liệu thời gian thực (Broadcast API).</p>
                </div>
                <div class="relative z-10 text-xs opacity-70">© 2025 Ngoc Anh Hotel System v4.1</div>
            </div>
            <div class="w-full md:w-1/2 p-8 flex flex-col relative">
                <div class="flex justify-end mb-6"><div class="text-xs text-slate-400 font-mono bg-slate-100 px-2 py-1 rounded">v4.1 UX/UI Fix</div></div>
                
                <div class="flex border-b border-slate-200 mb-8">
                    <button onclick="switchLoginTab('staff')" id="tab-login-staff" class="flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-all">Nhân viên</button>
                    <button onclick="switchLoginTab('guest')" id="tab-login-guest" class="flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all">Khách hàng</button>
                </div>

                <!-- Staff Login -->
                <div id="form-staff" class="flex-1 flex flex-col fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Đăng nhập nội bộ</h2>
                    <div class="space-y-4 mb-6">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tên đăng nhập</label><div class="relative"><i data-lucide="user" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"></i><input type="text" id="staff-username" class="w-full border border-slate-300 rounded-lg py-2.5 pl-10 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin hoặc letan"></div></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu</label><div class="relative"><i data-lucide="lock" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"></i><input type="password" id="staff-password" class="w-full border border-slate-300 rounded-lg py-2.5 pl-10 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••"></div></div>
                    </div>
                    <button onclick="handleStaffLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg">Truy cập</button>
                    <div class="mt-4 text-xs text-slate-400 text-center bg-slate-50 p-2 rounded border border-slate-100"><span class="font-bold">Gợi ý:</span> Lễ tân (letan/123) - Quản lý (admin/admin)</div>
                </div>

                <!-- Guest Login -->
                <div id="form-guest-login" class="hidden flex-1 flex-col fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Xin chào quý khách</h2>
                    <p class="text-sm text-slate-500 mb-6">Đăng nhập để đặt phòng và gọi dịch vụ.</p>
                    <div class="space-y-4 mb-6">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Số điện thoại</label><div class="relative"><i data-lucide="phone" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"></i><input type="tel" id="guest-login-phone" class="w-full border border-slate-300 rounded-lg py-2.5 pl-10 outline-none" placeholder="09xxxxxxxx"></div></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mật khẩu</label><div class="relative"><i data-lucide="key" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400"></i><input type="password" id="guest-login-pass" class="w-full border border-slate-300 rounded-lg py-2.5 pl-10 outline-none" placeholder="••••••"></div></div>
                    </div>
                    <button onclick="handleGuestLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg mb-4">Đăng nhập</button>
                    <div class="text-center text-sm text-slate-500">Chưa có tài khoản? <span class="auth-switch" onclick="toggleGuestMode('register')">Đăng ký ngay</span></div>
                </div>

                <!-- Guest Register -->
                <div id="form-guest-register" class="hidden flex-1 flex-col fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Đăng ký thành viên</h2>
                    <div class="space-y-3 mb-6">
                        <input type="text" id="guest-reg-name" class="w-full border p-2.5 rounded-lg text-sm" placeholder="Họ và tên">
                        <input type="tel" id="guest-reg-phone" class="w-full border p-2.5 rounded-lg text-sm" placeholder="Số điện thoại">
                        <input type="password" id="guest-reg-pass" class="w-full border p-2.5 rounded-lg text-sm" placeholder="Mật khẩu">
                    </div>
                    <button onclick="handleGuestRegister()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg mb-4">Tạo tài khoản</button>
                    <div class="text-center text-sm text-slate-500"><span class="auth-switch" onclick="toggleGuestMode('login')">Quay lại đăng nhập</span></div>
                </div>
            </div>
        </div>

    <!--  MAIN APP LAYOUT  -->
    <div id="main-app" class="flex-col h-full hidden">
        <!-- Main Header -->
        <div class="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md z-50 shrink-0">
            <div class="flex items-center gap-3"><i data-lucide="building-2" class="text-blue-400"></i><span class="font-bold tracking-wider text-lg hidden sm:inline">NGỌC ANH HOTEL</span><span class="font-bold tracking-wider text-lg sm:hidden">NA HOTEL</span></div>

            <!-- Đổi vai trò nhanh (Dành cho demo) -->
            <div class="hidden lg:flex bg-slate-800 rounded p-1 gap-1">
                <button onclick="quickSwitchRole('reception')" class="px-3 py-1 rounded text-xs font-bold hover:bg-blue-600 transition-colors text-slate-300 hover:text-white">Lễ tân</button>
                <button onclick="quickSwitchRole('manager')" class="px-3 py-1 rounded text-xs font-bold hover:bg-blue-600 transition-colors text-slate-300 hover:text-white">Quản lý</button>
                <button onclick="quickSwitchRole('guest')" class="px-3 py-1 rounded text-xs font-bold hover:bg-blue-600 transition-colors text-slate-300 hover:text-white">Khách</button>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 text-sm text-slate-300">
                    <span>Xin chào,</span>
                    <strong class="text-white" id="user-display-name">...</strong>
                    <span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded uppercase font-bold" id="user-role-badge">ROLE</span>
                </div>
                <button onclick="logout()" class="flex items-center gap-2 text-slate-300 hover:text-white transition-colors text-sm font-medium"><i data-lucide="log-out" class="w-4 h-4"></i> <span class="hidden sm:inline">Thoát</span></button>
            </div>
        </div>

        <div id="app-container" class="flex-1 overflow-hidden relative bg-slate-200">

            <!-- RECEPTION VIEW (PC) -->
            <div id="view-reception" class="hidden w-full h-full bg-slate-100 flex-row">
                <!-- Sidebar -->
                <div class="w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex shrink-0 z-20">
                    <nav class="flex-1 p-4 space-y-1 mt-4">
                        <button onclick="switchReceptionTab('rack')" id="nav-rack" class="w-full flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-600 rounded-lg font-medium border-l-4 border-blue-600 text-left transition-all"><i data-lucide="layout-dashboard"></i> Sơ đồ phòng</button>
                        <button onclick="switchReceptionTab('guests')" id="nav-guests" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-medium text-left border-l-4 border-transparent transition-all"><i data-lucide="users"></i> Khách lưu trú</button>
                        <button onclick="switchReceptionTab('bookings')" id="nav-bookings" class="w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-medium text-left border-l-4 border-transparent transition-all">
                            <div class="flex items-center gap-3"><i data-lucide="calendar-days"></i> Đặt trước</div>
                            <span id="booking-badge" class="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </nav>
                    <div class="p-4 border-t border-slate-200"><button onclick="clearData()" class="flex items-center gap-2 text-slate-400 hover:text-red-500 text-sm w-full px-4 py-2"><i data-lucide="trash-2"></i> Reset Dữ liệu</button></div>
                </div>

                <!-- Main Content -->
                <div class="flex-1 flex flex-col min-w-0 bg-slate-100 relative overflow-hidden">
                    
                    <!-- TAB: ROOM RACK -->
                    <div id="tab-rack" class="flex flex-col h-full fade-in">
                        <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 shadow-sm z-10">
                            <h2 class="text-xl font-bold text-slate-800">Sơ đồ phòng</h2>
                            <div class="flex gap-4 text-sm font-medium"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> Trống</div><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-rose-500"></span> Có khách</div><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-400"></span> Dọn dẹp</div></div>
                        </div>
                        <div id="pending-booking-bar" class="hidden bg-yellow-100 border-b border-yellow-200 p-3 px-6 flex justify-between items-center animate-pulse">
                            <div class="flex items-center gap-2 text-yellow-800"><i data-lucide="alert-circle" class="w-5 h-5"></i><span>Đang xếp phòng cho khách: <strong id="pending-guest-name">...</strong> (Loại: <span id="pending-room-type">...</span>)</span></div>
                            <button onclick="cancelPendingBooking()" class="text-xs text-slate-500 underline hover:text-slate-800">Hủy tác vụ</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 bg-slate-100"><div id="room-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 pb-20"></div></div>
                    </div>

                    <!-- TAB: GUESTS -->
                    <div id="tab-guests" class="hidden flex-col h-full fade-in bg-white">
                        <div class="h-16 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Khách đang lưu trú</h2>
                            <button onclick="renderGuests()" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded flex items-center gap-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Làm mới</button>
                        </div>
                        <div class="p-6 overflow-y-auto"><table class="w-full text-sm text-left border rounded-lg overflow-hidden"><thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs"><tr><th class="px-6 py-4">Phòng</th><th class="px-6 py-4">Khách hàng</th><th class="px-6 py-4">SĐT</th><th class="px-6 py-4">Giờ vào</th><th class="px-6 py-4">Tạm tính</th><th class="px-6 py-4 text-right">Thao tác</th></tr></thead><tbody id="guest-list-body" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>

                    <!-- TAB: BOOKINGS -->
                    <div id="tab-bookings" class="hidden flex-col h-full fade-in bg-slate-50">
                        <div class="h-16 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm justify-between">
                            <h2 class="text-xl font-bold text-slate-800">Quản lý Đặt phòng</h2>
                            <button onclick="renderBookings()" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded flex items-center gap-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Làm mới</button>
                        </div>
                        <div class="p-6 overflow-y-auto" id="booking-list"></div>
                    </div>
                </div>

                <!-- Right Detail Panel -->
                <div id="right-panel" class="w-80 bg-white border-l border-slate-200 shadow-xl z-10 hidden xl:flex flex-col transition-all shrink-0">
                    <div class="p-6 border-b border-slate-200 bg-slate-50"><h3 class="text-xs font-bold uppercase text-slate-500 tracking-wider">Chi tiết phòng</h3></div>
                    <div id="panel-content" class="flex-1 p-6 flex flex-col items-center justify-center text-slate-400"><i data-lucide="mouse-pointer-2" class="w-12 h-12 mb-3 opacity-20"></i><p class="text-sm">Chọn một phòng để xem</p></div>
                </div>
            </div>

            <!-- MANAGER VIEW (MOBILE) -->
            <div id="view-manager" class="hidden w-full h-full overflow-hidden bg-slate-800/10 backdrop-blur-sm p-0 md:p-4">
                <div class="w-full h-full max-w-[480px] mx-auto bg-slate-50 shadow-2xl overflow-hidden flex flex-col md:rounded-3xl border border-slate-300 relative">
                    <div class="flex-1 overflow-y-auto relative" id="mgr-content">
                        <div id="mgr-tab-dashboard" class="fade-in">
                            <div class="bg-blue-600 text-white p-6 md:rounded-b-3xl shadow-lg relative z-10 shrink-0">
                                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Dashboard</h2><i data-lucide="shield" class="w-6 h-6 opacity-80"></i></div>
                                <div class="grid grid-cols-2 gap-4"><div class="bg-white/10 p-4 rounded-2xl border border-white/10"><div class="text-xs text-blue-100 mb-1">Doanh thu</div><div class="text-2xl font-bold" id="mgr-revenue">0đ</div></div><div class="bg-white/10 p-4 rounded-2xl border border-white/10"><div class="text-xs text-blue-100 mb-1">Công suất</div><div class="text-2xl font-bold" id="mgr-occupancy">0%</div></div></div>
                            </div>
                            <div class="p-5 space-y-6">
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4 text-blue-500"></i> Trạng thái phòng</h3><div class="space-y-4"><div><div class="flex justify-between text-xs mb-1 font-bold"><span class="text-rose-600">Có khách</span><span id="stat-occupied-count">0</span></div><div class="w-full bg-slate-100 rounded-full h-2"><div id="bar-occupied" class="bg-rose-500 h-2 rounded-full transition-all" style="width: 0%"></div></div></div><div><div class="flex justify-between text-xs mb-1 font-bold"><span class="text-emerald-600">Trống</span><span id="stat-available-count">0</span></div><div class="w-full bg-slate-100 rounded-full h-2"><div id="bar-available" class="bg-emerald-500 h-2 rounded-full transition-all" style="width: 0%"></div></div></div><div><div class="flex justify-between text-xs mb-1 font-bold"><span class="text-amber-600">Chờ dọn</span><span id="stat-dirty-count">0</span></div><div class="w-full bg-slate-100 rounded-full h-2"><div id="bar-dirty" class="bg-amber-400 h-2 rounded-full transition-all" style="width: 0%"></div></div></div></div></div>
                                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden" id="mgr-transactions"><div class="p-6 text-center text-slate-400 text-sm">Chưa có giao dịch</div></div>
                            </div>
                        </div>
                        <div id="mgr-tab-config" class="hidden fade-in p-5 pb-20">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Cấu hình</h2>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6"><h3 class="font-bold mb-4 text-sm uppercase text-slate-500 border-b pb-2">Giá phòng</h3><div class="space-y-3"><div><label class="text-xs font-bold text-slate-500">Đơn</label><input type="number" id="cfg-price-single" class="w-full border p-2 rounded mt-1"></div><div><label class="text-xs font-bold text-slate-500">Đôi</label><input type="number" id="cfg-price-double" class="w-full border p-2 rounded mt-1"></div><div><label class="text-xs font-bold text-slate-500">VIP</label><input type="number" id="cfg-price-vip" class="w-full border p-2 rounded mt-1"></div></div></div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4"><h3 class="font-bold mb-4 text-sm uppercase text-slate-500 border-b pb-2">Dịch vụ</h3><div id="cfg-services-list" class="space-y-3 mb-4"></div><button onclick="addNewServiceRow()" class="w-full border border-dashed border-slate-300 text-slate-500 p-2 rounded hover:bg-slate-50 text-xs font-bold">+ Thêm</button></div>
                            <button onclick="saveManagerConfig()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6 shadow-lg hover:bg-blue-700">Lưu thay đổi</button>
                        </div>
                    </div>
                    <div class="bg-white border-t border-slate-200 p-2 flex justify-around items-center text-[10px] font-medium text-slate-400 z-20 shrink-0">
                        <div onclick="switchManagerTab('dashboard')" id="mnav-dashboard" class="flex flex-col items-center text-blue-600 gap-1 cursor-pointer transition-colors"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Tổng quan</span></div>
                        <div onclick="switchManagerTab('config')" id="mnav-config" class="flex flex-col items-center gap-1 cursor-pointer hover:text-blue-500 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i><span>Cấu hình</span></div>
                    </div>
                </div>
            </div>

            <!-- GUEST VIEW (MOBILE) -->
            <div id="view-guest" class="hidden w-full h-full overflow-hidden bg-slate-800/10 backdrop-blur-sm p-0 md:p-4">
                <div class="w-full h-full max-w-[480px] mx-auto bg-white shadow-2xl overflow-hidden flex flex-col md:rounded-3xl border border-slate-300 relative">
                    <div class="bg-slate-900 text-white p-4 flex justify-between items-center z-10 shadow-sm shrink-0">
                        <div class="flex items-center gap-2"><span class="font-bold text-lg">Ngoc Anh Hotel</span></div><span class="bg-emerald-500 text-white px-2 py-0.5 rounded text-xs font-bold hidden" id="guest-room-badge">...</span>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-slate-50 relative" id="guest-content-area">
                        <!-- HOME -->
                        <div id="guest-tab-home" class="fade-in h-full">
                            <div id="guest-home-active" class="hidden p-5 pb-20">
                                <div class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                                    <div class="relative z-10"><h1 class="text-xl font-bold mb-1">Xin chào <span class="guest-name-display">...</span>!</h1><p class="text-blue-100 text-xs mb-4">Chúc bạn nghỉ ngơi thoải mái.</p><div class="bg-white/10 backdrop-blur-md rounded-lg p-3 border border-white/10"><div class="flex justify-between items-end mb-1"><div class="text-xs text-blue-200">Tạm tính</div><div class="text-2xl font-bold" id="guest-total-bill">0đ</div></div><div class="text-[10px] text-blue-200 border-t border-white/10 pt-2 flex justify-between"><span>Phòng: <b id="guest-room-cost">0đ</b></span><span>Dịch vụ: <b id="guest-service-cost">0đ</b></span></div></div></div><i data-lucide="moon" class="absolute -bottom-4 -right-4 w-32 h-32 text-white opacity-10"></i>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm uppercase">Dịch vụ tại phòng</h3><div class="grid grid-cols-2 gap-3 mb-6" id="guest-services-grid"></div><button class="w-full bg-white border border-rose-200 text-rose-600 font-bold py-3 rounded-xl shadow-sm hover:bg-rose-50" onclick="showToast('Đã gửi yêu cầu trả phòng!')">Yêu cầu trả phòng</button>
                            </div>
                            <div id="guest-home-empty" class="hidden h-full flex flex-col items-center justify-center p-8 text-center pb-20"><div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-6"><i data-lucide="armchair" class="w-10 h-10 text-blue-400"></i></div><h3 class="text-xl font-bold text-slate-800 mb-2">Chưa có phòng</h3><p class="text-sm text-slate-500 mb-8 max-w-[240px]">Xin chào <span class="guest-name-display font-bold">...</span>, vui lòng đặt phòng mới hoặc đợi lễ tân check-in.</p><button onclick="switchGuestTab('search')" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 w-full max-w-xs transition-transform active:scale-95">Đặt phòng ngay</button></div>
                        </div>
                        <!-- SEARCH -->
                        <div id="guest-tab-search" class="hidden fade-in p-5 h-full overflow-y-auto pb-20">
                            <h2 class="font-bold text-xl mb-4 text-slate-800">Đặt phòng</h2>
                            <div class="space-y-4">
                                <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-slate-200"><div class="h-40 relative"><img src="https://images.unsplash.com/photo-1618773928121-c32242e63f39?auto=format&fit=crop&w=800&q=80" class="img-cover"><span class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur">VIP</span></div><div class="p-3"><div class="flex justify-between mb-2"><h4 class="font-bold">Phòng VIP hướng hồ</h4><span class="text-blue-600 font-bold">150k/h</span></div><button class="w-full bg-slate-900 text-white text-xs font-bold py-2 rounded active:scale-95 transition-transform" onclick="openGuestBookingModal('VIP')">Đặt ngay</button></div></div>
                                <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-slate-200"><div class="h-40 relative"><img src="https://images.unsplash.com/photo-1590490360182-c33d57733427?auto=format&fit=crop&w=800&q=80" class="img-cover"><span class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur">ĐÔI</span></div><div class="p-3"><div class="flex justify-between mb-2"><h4 class="font-bold">Phòng Đôi Tiêu Chuẩn</h4><span class="text-blue-600 font-bold">100k/h</span></div><button class="w-full bg-slate-900 text-white text-xs font-bold py-2 rounded active:scale-95 transition-transform" onclick="openGuestBookingModal('DOUBLE')">Đặt ngay</button></div></div>
                            </div>
                        </div>
                        <!-- ACCOUNT -->
                        <div id="guest-tab-account" class="hidden fade-in p-5 h-full overflow-y-auto pb-20">
                            <div class="flex items-center gap-4 mb-6"><div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold guest-name-initial">K</div><div><h2 class="font-bold text-lg guest-name-display">...</h2><div class="text-sm text-slate-500 guest-phone-display">...</div></div></div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4"><div class="p-3 border-b border-slate-100 font-bold text-sm bg-slate-50">Lịch sử giao dịch</div><div class="divide-y divide-slate-100" id="guest-history-list"><div class="p-4 text-center text-xs text-slate-400">Chưa có dữ liệu</div></div></div>
                            <button onclick="logout()" class="w-full bg-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-300 transition-colors">Đăng xuất</button>
                        </div>
                    </div>
                    <!-- GUEST NAV -->
                    <div class="bg-white border-t border-slate-200 p-2 flex justify-around items-center text-[10px] font-medium text-slate-400 z-20 shrink-0">
                        <div onclick="switchGuestTab('home')" id="g-nav-home" class="flex flex-col items-center text-blue-600 gap-1 cursor-pointer transition-colors"><i data-lucide="home" class="w-5 h-5"></i><span>Trang chủ</span></div>
                        <div onclick="switchGuestTab('search')" id="g-nav-search" class="flex flex-col items-center gap-1 cursor-pointer hover:text-blue-500 transition-colors"><i data-lucide="search" class="w-5 h-5"></i><span>Đặt phòng</span></div>
                        <div onclick="switchGuestTab('account')" id="g-nav-account" class="flex flex-col items-center gap-1 cursor-pointer hover:text-blue-500 transition-colors"><i data-lucide="user" class="w-5 h-5"></i><span>Tài khoản</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-checkin" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden modal-content"><div class="bg-blue-600 px-6 py-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg">Check-in P.<span id="modal-room-id"></span></h3><button onclick="closeModal('modal-checkin')" class="hover:bg-blue-700 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6"><input type="hidden" id="pending-booking-id"><div class="grid grid-cols-3 gap-2 mb-6"><label class="cursor-pointer"><input type="radio" name="checkin-type" value="hourly" class="peer hidden" checked><div class="border rounded-lg p-2 text-center text-xs font-bold peer-checked:bg-blue-50 peer-checked:border-blue-600 text-slate-500 peer-checked:text-blue-600">THEO GIỜ</div></label><label class="cursor-pointer"><input type="radio" name="checkin-type" value="overnight" class="peer hidden"><div class="border rounded-lg p-2 text-center text-xs font-bold peer-checked:bg-blue-50 peer-checked:border-blue-600 text-slate-500 peer-checked:text-blue-600">QUA ĐÊM</div></label><label class="cursor-pointer"><input type="radio" name="checkin-type" value="daily" class="peer hidden"><div class="border rounded-lg p-2 text-center text-xs font-bold peer-checked:bg-blue-50 peer-checked:border-blue-600 text-slate-500 peer-checked:text-blue-600">THEO NGÀY</div></label></div><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Họ tên <span class="text-red-500">*</span></label><input type="text" id="guest-name" class="w-full border p-2.5 rounded-lg" placeholder="Nhập tên..."></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Số điện thoại</label><input type="tel" id="guest-phone" class="w-full border p-2.5 rounded-lg" placeholder="Ví dụ: 0912345678"></div><button onclick="confirmCheckIn()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg">NHẬN PHÒNG</button></div></div></div></div>
    <div id="modal-guest-booking" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden modal-content"><div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold">Xác nhận đặt phòng</h3><button onclick="closeModal('modal-guest-booking')"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6"><input type="hidden" id="booking-room-type"><p class="mb-4 text-sm text-slate-600">Bạn đang đặt phòng loại <strong id="booking-type-display">...</strong>. Lễ tân sẽ xếp phòng cho bạn khi đến nơi.</p><button onclick="confirmGuestBooking()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">Gửi yêu cầu <i data-lucide="send" class="w-4 h-4"></i></button></div></div></div>
    <div id="modal-checkout" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-4xl h-[550px] rounded-2xl shadow-2xl overflow-hidden flex modal-content"><div class="w-1/2 bg-slate-50 p-6 border-r flex flex-col"><h3 class="font-bold text-xl mb-4 flex items-center gap-2"><i data-lucide="receipt"></i> Hóa đơn P.<span id="checkout-room-number"></span></h3><div class="flex-1 bg-white border p-4 rounded-lg shadow-sm overflow-y-auto font-mono text-sm space-y-2"><div class="flex justify-between text-slate-500"><span>Giờ vào:</span><span id="bill-checkin-time" class="font-bold text-slate-800">--</span></div><div class="border-b border-dashed my-2"></div><div class="flex justify-between"><span>Tiền phòng:</span><span id="bill-room-price" class="font-bold">0đ</span></div><div id="bill-services" class="space-y-1 text-xs text-slate-600 pt-2"></div></div><div class="mt-4 pt-4 border-t"><div class="flex justify-between text-xl font-bold text-blue-600 mb-4"><span>Tổng cộng:</span><span id="bill-total">0đ</span></div><button onclick="confirmCheckOut()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700">THANH TOÁN & TRẢ PHÒNG</button><button onclick="closeModal('modal-checkout')" class="w-full mt-2 text-slate-500 text-sm hover:underline">Hủy bỏ</button></div></div><div class="w-1/2 p-6 bg-white overflow-y-auto"><h3 class="font-bold mb-4">Thêm dịch vụ</h3><div class="grid grid-cols-2 gap-3 mb-4" id="checkout-services-grid"></div><div><label class="text-xs font-bold text-slate-500">Phụ thu / Giảm giá</label><input type="number" id="surcharge-input" onchange="updateTotal()" class="w-full border p-2 rounded-lg mt-1" placeholder="Nhập số tiền..."></div></div></div></div>
    <div id="toast" class="toast"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i> <span id="toast-msg">Thông báo</span></div>

    <!-- JAVASCRIPT -->
    <script>
        const ROOM_TYPES = { SINGLE: { label: 'Đơn', color: 'text-emerald-600 bg-emerald-100' }, DOUBLE: { label: 'Đôi', color: 'text-blue-600 bg-blue-100' }, VIP: { label: 'VIP', color: 'text-purple-600 bg-purple-100' } };
        let PRICES = { SINGLE: 80000, DOUBLE: 100000, VIP: 150000 };
        let SERVICES = [{ id: 1, name: 'Nước suối', price: 10000, image: 'https://images.unsplash.com/photo-1548839140-29a749e1cf4d?auto=format&fit=crop&w=200&q=80' }, { id: 2, name: 'Mì bò trứng', price: 30000, image: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=200&q=80' }, { id: 3, name: 'Bò húc', price: 20000, image: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=200&q=80' }, { id: 4, name: 'Khăn lạnh', price: 5000, image: 'https://images.unsplash.com/photo-1517686469429-8bdb88b9f907?auto=format&fit=crop&w=200&q=80' }];
        let rooms = Array.from({ length: 15 }, (_, i) => { const floor = Math.floor(i / 5) + 1; const num = i % 5 + 1; return { id: `R${floor}0${num}`, number: `${floor}0${num}`, type: num === 5 ? 'VIP' : (num > 2 ? 'DOUBLE' : 'SINGLE'), status: 'available', guestName: '', guestPhone: '', checkInTime: null, services: [] }; });
        let bookings = []; let guestAccounts = [{name: 'Khách Demo', phone: '0912345678', password: '123'}]; let transactions = []; let totalRevenue = 0; let currentUser = null; 
        let pendingBookingData = null; let selectedRoomId = null; let currentRoomBasePrice = 0; let currentBillServicesTotal = 0;
        
        const channel = new BroadcastChannel('hotel_sync');

        function init() {
            loadData();
            if (sessionStorage.getItem('hotel_user')) { currentUser = JSON.parse(sessionStorage.getItem('hotel_user')); showMainApp(); } else { showLoginScreen(); }
            lucide.createIcons();
            setInterval(() => { if(currentUser?.role === 'guest') updateGuestView(); }, 1000);
            window.addEventListener('storage', (e) => { loadData(); triggerRealtimeUpdate(); });
            channel.onmessage = (event) => { if(event.data === 'update') { loadData(); triggerRealtimeUpdate(); } };
        }

        function saveData() { 
            const data = { rooms, bookings, transactions, totalRevenue, guestAccounts, PRICES, SERVICES };
            localStorage.setItem('hotel_data_v41', JSON.stringify(data)); 
            channel.postMessage('update'); triggerRealtimeUpdate(); 
        }
        function triggerRealtimeUpdate() {
            if(!currentUser) return;
            if(currentUser.role === 'reception') { renderRooms(); renderBookings(); renderGuests(); updateBookingBadge(); }
            if(currentUser.role === 'manager') renderManagerDashboard();
            if(currentUser.role === 'guest') { updateGuestView(); renderGuestHistory(); }
        }
        function loadData() {
            const data = JSON.parse(localStorage.getItem('hotel_data_v41'));
            if(data) {
                rooms = data.rooms; bookings = data.bookings; transactions = data.transactions; totalRevenue = data.totalRevenue; guestAccounts = data.guestAccounts;
                if(data.PRICES) PRICES = data.PRICES; if(data.SERVICES) SERVICES = data.SERVICES;
                rooms.forEach(r => { if(r.checkInTime) r.checkInTime = new Date(r.checkInTime); });
            }
        }
        function clearData() { if(confirm("Xóa sạch dữ liệu?")) { localStorage.removeItem('hotel_data_v41'); location.reload(); } }

        // --- AUTH ---
        function switchLoginTab(type) { document.getElementById('form-staff').classList.add('hidden'); document.getElementById('form-guest-login').classList.add('hidden'); document.getElementById('form-guest-register').classList.add('hidden'); document.getElementById('tab-login-staff').className = "flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all"; document.getElementById('tab-login-guest').className = "flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-all"; if(type === 'staff') document.getElementById('form-staff').classList.remove('hidden'); else document.getElementById('form-guest-login').classList.remove('hidden'); document.getElementById(`tab-login-${type}`).className = "flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-all"; }
        function toggleGuestMode(mode) { document.getElementById('form-guest-login').classList.add('hidden'); document.getElementById('form-guest-register').classList.add('hidden'); document.getElementById(`form-guest-${mode}`).classList.remove('hidden'); }
        function handleStaffLogin() { const u = document.getElementById('staff-username').value.toLowerCase(); const p = document.getElementById('staff-password').value; if ((u === 'letan' && p === '123') || u === 'letan') loginSuccess({ role: 'reception', name: 'Lễ Tân' }); else if ((u === 'admin' && p === 'admin') || u === 'manager') loginSuccess({ role: 'manager', name: 'Quản Lý' }); else alert('Sai thông tin đăng nhập!'); }
        function handleGuestLogin() { const p = document.getElementById('guest-login-phone').value; const pass = document.getElementById('guest-login-pass').value; const acc = guestAccounts.find(a => a.phone === p && a.password === pass); if (acc) loginSuccess({ role: 'guest', name: acc.name, phone: acc.phone }); else alert('Sai SĐT hoặc mật khẩu!'); }
        function handleGuestRegister() { const n = document.getElementById('guest-reg-name').value; const p = document.getElementById('guest-reg-phone').value; const pass = document.getElementById('guest-reg-pass').value; if (!n || !p || !pass) return alert('Vui lòng điền đủ!'); if (guestAccounts.find(a => a.phone === p)) return alert('SĐT đã tồn tại!'); guestAccounts.push({ name: n, phone: p, password: pass }); saveData(); alert('Đăng ký thành công!'); toggleGuestMode('login'); }
        function loginSuccess(user) { currentUser = user; sessionStorage.setItem('hotel_user', JSON.stringify(user)); document.getElementById('login-screen').classList.add('hidden'); showMainApp(); }
        function logout() { sessionStorage.removeItem('hotel_user'); currentUser = null; location.reload(); }
        function showLoginScreen() { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
        function quickSwitchRole(role) { let user = { role: role, name: role === 'reception' ? 'Lễ Tân Demo' : (role === 'manager' ? 'Quản Lý Demo' : 'Khách Demo'), phone: '0912345678' }; loginSuccess(user); }
        function showMainApp() {
            document.getElementById('main-app').classList.remove('hidden'); document.getElementById('main-app').classList.add('flex');
            document.getElementById('user-display-name').innerText = currentUser.name; document.getElementById('user-role-badge').innerText = currentUser.role.toUpperCase();
            ['reception', 'manager', 'guest'].forEach(v => { document.getElementById(`view-${v}`).classList.add('hidden'); document.getElementById(`view-${v}`).classList.remove('flex'); });
            if (currentUser.role === 'reception') { const el = document.getElementById('view-reception'); el.classList.remove('hidden'); el.classList.add('flex'); renderRooms(); renderGuests(); renderBookings(); updateBookingBadge(); }
            else if (currentUser.role === 'manager') { document.getElementById('view-manager').classList.remove('hidden'); switchManagerTab('dashboard'); }
            else if (currentUser.role === 'guest') { document.getElementById('view-guest').classList.remove('hidden'); updateGuestView(); renderGuestServicesGrid(); }
            lucide.createIcons();
        }

        // --- RECEPTION LOGIC ---
        function switchReceptionTab(tabName) {
            ['rack', 'guests', 'bookings'].forEach(t => { document.getElementById(`tab-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).classList.remove('flex'); document.getElementById(`nav-${t}`).className = "w-full flex items-center gap-3 px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-lg font-medium transition-all text-left border-l-4 border-transparent"; });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden'); document.getElementById(`tab-${tabName}`).classList.add('flex');
            document.getElementById(`nav-${tabName}`).className = "w-full flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-600 rounded-lg font-medium border-l-4 border-blue-600 transition-all text-left";
            const rp = document.getElementById('right-panel'); if(tabName === 'rack') { rp.classList.remove('hidden'); rp.classList.add('flex'); } else { rp.classList.add('hidden'); rp.classList.remove('flex'); }
            if(tabName === 'bookings') renderBookings(); if(tabName === 'guests') renderGuests(); lucide.createIcons();
        }

        function handleRoomClick(id) {
            const room = rooms.find(r => r.id === id); selectedRoomId = id;
            if (room.status === 'dirty') return; 
            if (pendingBookingData && room.status === 'available') { if (room.type !== pendingBookingData.roomType && !confirm(`Khác loại phòng. Tiếp tục?`)) return; document.getElementById('modal-room-id').innerText = room.number; document.getElementById('guest-name').value = pendingBookingData.guest; document.getElementById('guest-phone').value = pendingBookingData.phone; document.getElementById('pending-booking-id').value = pendingBookingData.id; openModal('modal-checkin'); return; }
            if (room.status === 'available') { document.getElementById('modal-room-id').innerText = room.number; document.getElementById('guest-name').value = ''; document.getElementById('guest-phone').value = ''; document.getElementById('pending-booking-id').value = ''; openModal('modal-checkin'); }
            else if (room.status === 'occupied') { prepareCheckout(room); openModal('modal-checkout'); }
            const panel = document.getElementById('panel-content'); if (panel) { let stt = room.status === 'available' ? 'TRỐNG' : (room.status === 'occupied' ? 'CÓ KHÁCH' : 'DỌN DẸP'); panel.innerHTML = `<div class="w-full space-y-4 fade-in text-center"><div class="text-5xl font-bold text-slate-800">${room.number}</div><div class="inline-block px-3 py-1 rounded bg-slate-100 text-slate-600 text-xs font-bold">${stt}</div><div class="text-left space-y-2 mt-4 text-sm"><div class="flex justify-between"><span>Loại:</span> <b>${ROOM_TYPES[room.type].label}</b></div>${room.status === 'occupied' ? `<div class="flex justify-between"><span>Khách:</span> <b>${room.guestName}</b></div><div class="flex justify-between"><span>SĐT:</span> <b>${room.guestPhone || '--'}</b></div>` : ''}</div></div>`; }
        }

        function renderRooms() {
            const grid = document.getElementById('room-grid'); if(!grid) return; grid.innerHTML = '';
            rooms.forEach(room => {
                let color = room.status === 'available' ? 'bg-emerald-500' : (room.status === 'occupied' ? 'bg-rose-500' : 'bg-amber-400');
                let border = room.status === 'available' ? 'border-slate-200' : (room.status === 'occupied' ? 'border-rose-200 bg-rose-50' : 'border-amber-200 bg-amber-50');
                let el = document.createElement('div'); el.className = `room-card relative h-36 rounded-xl shadow border cursor-pointer overflow-hidden bg-white select-none ${border}`;
                if(room.status !== 'dirty') el.onclick = () => handleRoomClick(room.id);
                let content = `<div class="h-1.5 w-full ${color}"></div><div class="p-4 flex flex-col h-full justify-between"><div class="flex justify-between items-start"><span class="text-2xl font-bold text-slate-700">${room.number}</span><span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">${ROOM_TYPES[room.type].label}</span></div>`;
                if (room.status === 'occupied') content += `<div class="mt-1"><div class="text-xs text-rose-600 font-bold mb-1">Đang sử dụng</div><div class="text-xs text-slate-500 truncate">${room.guestName}</div></div>`;
                else if (room.status === 'dirty') content += `<button onclick="cleanRoom('${room.id}', event)" class="mt-auto w-full bg-amber-100 text-amber-700 text-xs font-bold py-2 rounded hover:bg-amber-200 transition-colors z-20">DỌN XONG</button>`;
                else content += '<div class="text-xs text-emerald-600 font-bold">Sẵn sàng</div>';
                content += '</div>'; el.innerHTML = content; grid.appendChild(el);
            });
        }

        function renderGuests() { const tb = document.getElementById('guest-list-body'); if(!tb) return; tb.innerHTML=''; rooms.filter(r=>r.status==='occupied').forEach(r=>{ let tr=document.createElement('tr'); tr.innerHTML=`<td class="px-6 py-4 font-bold text-blue-600">${r.number}</td><td class="px-6 py-4 font-medium">${r.guestName}<br><span class="text-xs text-slate-400">${r.guestPhone||''}</span></td><td class="px-6 py-4 text-xs">${r.guestPhone||''}</td><td class="px-6 py-4 text-xs">${r.checkInTime?.toLocaleTimeString()||''}</td><td class="px-6 py-4 font-bold">${(PRICES[r.type]+r.services.reduce((a,b)=>a+b.price,0)).toLocaleString()}đ</td><td class="px-6 py-4 text-right"><button onclick="handleRoomClick('${r.id}')" class="text-xs bg-slate-100 px-2 py-1 rounded">Xem</button></td>`; tb.appendChild(tr); }); }
        
        function confirmCheckIn() {
            const name = document.getElementById('guest-name').value;
            const phone = document.getElementById('guest-phone').value;
            if(!name) { alert("Vui lòng nhập tên khách hàng!"); return; } // Validation

            const r = rooms.find(r => r.id === selectedRoomId);
            r.status = 'occupied'; r.guestName = name; r.guestPhone = phone; r.checkInTime = new Date();

            if(document.getElementById('pending-booking-id').value) {
                const bid = parseInt(document.getElementById('pending-booking-id').value);
                bookings = bookings.filter(b => b.id !== bid);
                cancelPendingBooking();
            }

            saveData();
            closeModal('modal-checkin');
            showToast("Check-in thành công!");
            
            // UX Enhancement: Auto switch to Guests list briefly then back or stay
            switchReceptionTab('guests'); // Show the updated guest list immediately
        }

        function checkInFromBooking(bookingId, guestName, type) { const room = rooms.find(r => r.type === type && r.status === 'available'); if (!room) { alert(`Hết phòng ${type}!`); return; } const booking = bookings.find(b => b.id === bookingId); let phone = ""; if (booking && booking.note && booking.note.includes('SĐT:')) phone = booking.note.split('SĐT:')[1].trim(); else if(booking && booking.phone) phone = booking.phone; pendingBookingData = booking; document.getElementById('pending-booking-bar').classList.remove('hidden'); document.getElementById('pending-guest-name').innerText = guestName; document.getElementById('pending-room-type').innerText = ROOM_TYPES[type].label; showToast("Vui lòng chọn phòng trống trên sơ đồ"); switchReceptionTab('rack'); }
        function cancelPendingBooking() { pendingBookingData = null; document.getElementById('pending-booking-bar').classList.add('hidden'); }
        function confirmGuestBooking() { const type = document.getElementById('booking-room-type').value; bookings.push({ id: Date.now(), guest: currentUser.name, phone: currentUser.phone, roomType: type, checkIn: new Date().toLocaleDateString('vi-VN'), status: 'pending' }); saveData(); closeModal('modal-guest-booking'); showToast("Đã gửi yêu cầu!"); switchGuestTab('home'); renderBookings(); updateBookingBadge(); }
        
        function switchManagerTab(tabName) { document.getElementById('mgr-tab-dashboard').classList.add('hidden'); document.getElementById('mgr-tab-config').classList.add('hidden'); document.getElementById('mnav-dashboard').classList.remove('text-blue-600'); document.getElementById('mnav-config').classList.remove('text-blue-600'); document.getElementById(`mgr-tab-${tabName}`).classList.remove('hidden'); document.getElementById(`mnav-${tabName}`).classList.add('text-blue-600'); if(tabName === 'dashboard') renderManagerDashboard(); if(tabName === 'config') renderManagerConfig(); }
        function renderManagerConfig() { document.getElementById('cfg-price-single').value = PRICES.SINGLE; document.getElementById('cfg-price-double').value = PRICES.DOUBLE; document.getElementById('cfg-price-vip').value = PRICES.VIP; const list = document.getElementById('cfg-services-list'); list.innerHTML = ''; SERVICES.forEach((s, idx) => { list.innerHTML += `<div class="flex gap-2 items-center"><input type="text" value="${s.name}" class="border p-2 rounded text-xs flex-1" onchange="updateService(${idx}, 'name', this.value)"><input type="number" value="${s.price}" class="border p-2 rounded text-xs w-20" onchange="updateService(${idx}, 'price', this.value)"><button class="text-red-500 p-2" onclick="deleteService(${idx})"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; }); lucide.createIcons(); }
        function saveManagerConfig() { PRICES.SINGLE = parseInt(document.getElementById('cfg-price-single').value); PRICES.DOUBLE = parseInt(document.getElementById('cfg-price-double').value); PRICES.VIP = parseInt(document.getElementById('cfg-price-vip').value); saveData(); showToast("Đã lưu cấu hình!"); }
        function updateService(idx, f, v) { SERVICES[idx][f] = (f==='price')?parseInt(v):v; }
        function deleteService(idx) { SERVICES.splice(idx, 1); renderManagerConfig(); }
        function addNewServiceRow() { SERVICES.push({id: Date.now(), name: 'Món mới', price: 0, image: ''}); renderManagerConfig(); }
        function renderManagerDashboard() { document.getElementById('mgr-revenue').innerText = totalRevenue.toLocaleString() + 'đ'; const occ = rooms.length ? Math.round((rooms.filter(r=>r.status==='occupied').length/rooms.length)*100) : 0; document.getElementById('mgr-occupancy').innerText = occ + '%'; document.getElementById('stat-occupied-count').innerText = rooms.filter(r=>r.status==='occupied').length; document.getElementById('bar-occupied').style.width = occ + '%'; const list = document.getElementById('mgr-transactions'); if(transactions.length === 0) list.innerHTML = '<div class="p-6 text-center text-slate-400 text-sm">Chưa có giao dịch</div>'; else { list.innerHTML = ''; transactions.slice().reverse().forEach(t => { list.innerHTML += `<div class="p-3 border-b border-slate-50 flex justify-between items-center hover:bg-slate-50"><div class="flex items-center gap-3"><div class="bg-green-100 text-green-600 p-2 rounded-lg"><i data-lucide="check-circle" class="w-4 h-4"></i></div><div><div class="text-sm font-bold text-slate-700">Thanh toán P.${t.room}</div><div class="text-xs text-slate-400">${t.time}</div></div></div><div class="font-bold text-blue-600">+${t.amount.toLocaleString()}đ</div></div>`; }); lucide.createIcons(); } }

        function updateGuestView() {
            const room = getGuestRoom();
            const homeActive = document.getElementById('guest-home-active');
            const homeEmpty = document.getElementById('guest-home-empty');
            if(currentUser) {
                document.querySelectorAll('.guest-name-display').forEach(el => el.innerText = currentUser.name);
                document.querySelectorAll('.guest-phone-display').forEach(el => el.innerText = currentUser.phone);
                document.querySelectorAll('.guest-name-initial').forEach(el => el.innerText = currentUser.name.charAt(0).toUpperCase());
            }
            if (homeActive && homeEmpty) {
                if (room) {
                    homeActive.classList.remove('hidden'); homeEmpty.classList.add('hidden');
                    const badge = document.getElementById('guest-room-badge'); if(badge) { badge.innerText = `P.${room.number}`; badge.classList.remove('hidden'); }
                    let rPrice = PRICES[room.type]; let sPrice = room.services.reduce((a,b)=>a+b.price,0);
                    const elTotal = document.getElementById('guest-total-bill'); if(elTotal) elTotal.innerText = (rPrice+sPrice).toLocaleString() + 'đ';
                    const elRoom = document.getElementById('guest-room-cost'); if(elRoom) elRoom.innerText = rPrice.toLocaleString() + 'đ';
                    const elServ = document.getElementById('guest-service-cost'); if(elServ) elServ.innerText = sPrice.toLocaleString() + 'đ';
                } else {
                    homeActive.classList.add('hidden'); homeEmpty.classList.remove('hidden');
                    const badge = document.getElementById('guest-room-badge'); if(badge) badge.classList.add('hidden');
                }
            }
        }
        function renderGuestServicesGrid() { const grid = document.getElementById('guest-services-grid'); if(!grid) return; grid.innerHTML = ''; SERVICES.forEach(s => { grid.innerHTML += `<div class="bg-white p-3 rounded-xl border hover:border-blue-500 cursor-pointer flex flex-col items-center gap-2 shadow-sm active:scale-95 transition-transform" onclick="guestOrder('${s.name}', ${s.price})"><img src="${s.image}" class="w-12 h-12 rounded-lg object-cover"><div class="text-center"><div class="font-bold text-xs">${s.name}</div><div class="text-[10px] text-slate-500">${s.price.toLocaleString()}</div></div></div>`; }); }

        function cleanRoom(id, e) { if(e) e.stopPropagation(); const r = rooms.find(r => r.id === id); r.status = 'available'; r.guestName = ''; r.guestPhone = ''; r.services = []; saveData(); renderRooms(); if(currentUser.role === 'manager') renderManagerDashboard(); }
        function prepareCheckout(room) { document.getElementById('checkout-room-number').innerText = room.number; document.getElementById('bill-checkin-time').innerText = room.checkInTime ? room.checkInTime.toLocaleTimeString() : '--'; const list = document.getElementById('bill-services'); list.innerHTML = ''; room.services.forEach(s => { list.innerHTML += `<div class="flex justify-between"><span>${s.name}</span><span>${s.price.toLocaleString()}đ</span></div>`; }); document.getElementById('bill-room-price').innerText = PRICES[room.type].toLocaleString() + 'đ'; let total = PRICES[room.type] + room.services.reduce((a,b)=>a+b.price,0); document.getElementById('bill-total').innerText = total.toLocaleString() + 'đ'; const grid = document.getElementById('checkout-services-grid'); grid.innerHTML = ''; SERVICES.forEach(s => { grid.innerHTML += `<button onclick="addService('${s.name}', ${s.price})" class="border p-3 rounded-lg hover:bg-blue-50 text-left text-sm font-bold transition-all flex items-center gap-2"><img src="${s.image}" class="w-6 h-6 rounded object-cover"> ${s.name}</button>`; }); }
        function confirmCheckOut() { const r = rooms.find(r => r.id === selectedRoomId); if(!r) return; const amount = parseInt(document.getElementById('bill-total').innerText.replace(/\D/g,'')); transactions.push({room: r.number, amount: amount, time: new Date().toLocaleTimeString(), guestPhone: r.guestPhone}); totalRevenue += amount; r.status = 'dirty'; r.checkInTime = null; r.services = []; r.guestPhone = ''; saveData(); closeModal('modal-checkout'); renderRooms(); renderManagerDashboard(); renderGuestHistory(); renderGuests(); switchReceptionTab('rack'); }
        function getGuestRoom() { return (currentUser && currentUser.role === 'guest') ? rooms.find(r => r.status === 'occupied' && r.guestPhone === currentUser.phone) : null; }
        function switchGuestTab(tabName) { ['home', 'search', 'account'].forEach(t => { document.getElementById(`guest-tab-${t}`).classList.add('hidden'); document.getElementById(`g-nav-${t}`).classList.remove('text-blue-600'); }); document.getElementById(`guest-tab-${tabName}`).classList.remove('hidden'); document.getElementById(`g-nav-${tabName}`).classList.add('text-blue-600'); if(tabName === 'home') updateGuestView(); if(tabName === 'account') renderGuestHistory(); lucide.createIcons(); }
        function guestOrder(n,p) { const r = getGuestRoom(); if(!r) { alert("Lỗi: Bạn chưa Check-in!"); return; } r.services.push({name:n, price:p}); saveData(); showToast(`Đã gọi ${n} thành công!`); updateGuestView(); }
        function openGuestBookingModal(type) { document.getElementById('booking-room-type').value = type; openModal('modal-guest-booking'); }
        function renderBookings() { const list = document.getElementById('booking-list'); if(!list) return; list.innerHTML = ''; bookings.forEach(bk => { list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-3 flex flex-col gap-3"><div><div class="flex justify-between"><span class="font-bold text-slate-800">${bk.guest}</span><span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold uppercase">${bk.roomType}</span></div><div class="text-xs text-slate-500 mt-1">SĐT: ${bk.phone || 'N/A'} - Ngày: ${bk.checkIn}</div></div><button onclick="checkInFromBooking(${bk.id}, '${bk.guest}', '${bk.roomType}')" class="bg-blue-600 text-white text-xs font-bold py-2 rounded hover:bg-blue-700">NHẬN PHÒNG</button></div>`; }); updateBookingBadge(); }
        function updateBookingBadge() { const badge = document.getElementById('booking-badge'); if(badge) { badge.innerText = bookings.length; badge.classList.toggle('hidden', bookings.length === 0); } }
        function cancelPendingBooking() { pendingBookingData = null; document.getElementById('pending-booking-bar').classList.add('hidden'); }
        function addService(n,p) { const r = rooms.find(r=>r.id===selectedRoomId); r.services.push({name:n, price:p}); saveData(); const el = document.createElement('div'); el.className = "flex justify-between"; el.innerHTML = `<span>${n}</span><span>${p.toLocaleString()}đ</span>`; document.getElementById('bill-services').appendChild(el); let total = PRICES[r.type] + r.services.reduce((a,b)=>a+b.price,0); document.getElementById('bill-total').innerText = total.toLocaleString() + 'đ'; }
        function renderGuestHistory() { const list = document.getElementById('guest-history-list'); if(!list) return; const myHistory = transactions.filter(t => t.guestPhone === currentUser.phone); if(myHistory.length === 0) { list.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs">Chưa có lịch sử giao dịch</div>'; return; } list.innerHTML = ''; myHistory.slice().reverse().forEach(t => { list.innerHTML += `<div class="p-4 hover:bg-slate-50"><div class="flex justify-between mb-1"><span class="font-bold text-sm">Phòng ${t.room}</span><span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">Hoàn thành</span></div><div class="text-xs text-slate-500 flex justify-between"><span>${t.time}</span><span class="font-bold">${t.amount.toLocaleString()}đ</span></div></div>`; }); }
        
        function showToast(msg) { const t = document.getElementById("toast"); t.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i> ${msg}`; t.className = "toast show"; lucide.createIcons(); setTimeout(()=>t.className = t.className.replace("show",""), 3000); }
        function updateTimers() { /* Timer logic */ }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).classList.remove('opacity-0'),10); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0'); setTimeout(()=>document.getElementById(id).classList.add('hidden'),200); }
        function toggleDarkMode() { document.body.classList.toggle('bg-slate-900'); document.body.classList.toggle('text-white'); }
        init();
    </script>
</body>
</html>